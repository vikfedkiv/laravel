dist: bionic
env:
  global:
  - DEBIAN_FRONTEND=noninteractive
before_install:
- openssl aes-256-cbc -K $encrypted_dfdcfd5172af_key -iv $encrypted_dfdcfd5172af_iv
  -in deploy_key.enc -out ./deploy_key -d
- eval "$(ssh-agent -s)"
- chmod 600 ./deploy_key
- echo -e "Host $HOSTNAME_STAGING\n\tStrictHostKeyChecking no\n" >> ~/.ssh/config
- ssh-add ./deploy_key
- sudo mysql -e "use mysql; update user set authentication_string=PASSWORD('root')
  where User='root'; update user set plugin='mysql_native_password';FLUSH PRIVILEGES;"
- sudo mysql_upgrade -u root -proot
- sudo service mysql restart
- composer global require hirak/prestissimo
- echo '$SSH_KEY_STAGING' >> $HOME/.ssh/id_rsa.pub
- chmod 600 $HOME/.ssh/id_rsa.pub
language: php
php:
- 7.4
services:
- mysql
- docker
cache:
  directories:
  - node_modules
before_script:
- cp .env.example .env
- sudo mysql -uroot -proot -e 'CREATE DATABASE laravel;'
- sudo mysql -uroot -proot -e "CREATE USER 'keller'@'localhost' IDENTIFIED BY 'password';"
- sudo mysql -uroot -proot -e "GRANT ALL ON laravel.* TO 'keller'@'localhost';"
- composer self-update
- COMPOSER_MEMORY_LIMIT=-1 travis_retry composer install --prefer-dist --no-interaction
- php artisan key:generate
- php artisan migrate
jobs:
  include:
  - stage: Tests
    name: Backend Tests
    script:
    - echo "backend test 1"
    - echo "backend test 2"
  - script:
    - echo "frontend test 1"
    - echo "frontend test 2"
    name: Frontend Tests
  - stage: Deploy
    name: Deploy to staging
    script:
    - ssh -i ./deploy_key ubuntu@$HOSTNAME_STAGING echo "Hello World!"
after_success:
- docker --version
