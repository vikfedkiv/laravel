name: Staging deployment

on:
  push:
    branches: [ master ]

jobs:
  staging_prepare:
    runs-on: self-hosted
    steps:
      - name: Checkout ðŸ‘€
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          lfs: false
      - name: Staging prepare ðŸš—
        run: |
          echo "Staging prepare."
          LATEST_TAG=$( git describe --tags --abbrev=0 )
          NEW_TAG=$(echo $LATEST_TAG | awk -F '.' '{ print $1 "." $2 "." $3+1 }')
          git tag $NEW_TAG
          git push origin $NEW_TAG
  staging_tests:
    uses: ./.github/workflows/ci.yml
    needs: [staging_prepare]
