name: Staging deployment

on:
  push:
    branches: [ master ]

jobs:
  staging_prepare:
    runs-on: self-hosted
    if: contains(split(vars.ALLOWED_USER, ","), github.actor)
    steps:
      - name: Checkout ðŸ‘€
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          lfs: false
      - name: Staging prepare ðŸš—
        run: |
          echo "Staging prepare."
          LATEST_TAG=$( git describe --tags --abbrev=0 )
          NEW_TAG=$(echo $LATEST_TAG | awk -F '.' '{ print $1 "." $2 "." $3+1 }')
          git tag $NEW_TAG
          git push origin $NEW_TAG
  staging_frontend_build:
    runs-on: self-hosted
    needs: [staging_prepare]
    steps:
      - name: Staging FrontEnd Build ðŸš—
        run: |
          echo "Staging FrontEnd build."
  staging_container_build:
    runs-on: self-hosted
    needs: [staging_prepare]
    steps:
      - name: Staging Container Build ðŸš—
        run: |
          echo "Staging container build."
  staging_deploy:
    runs-on: self-hosted
    needs: [staging_frontend_build, staging_container_build]
    steps:
      - name: Staging Deploy ðŸš—
        run: |
          echo "Staging Deploy."
  staging_tests:
    uses: ./.github/workflows/ci.yml
    needs: [staging_deploy]
  e2e_cypress_staging:
    runs-on: self-hosted
    needs: [staging_deploy]
    steps:
      - name: E2E Staging Cypress tests ðŸš—
        run: |
          echo "Staging e2e_cypress tests..."
