name: Staging deployment

on:
  push:
    branches: [ master ]

jobs:
  staging_prepare:
    name: Staging prepare
    environment: staging
    runs-on: self-hosted
    outputs:
      new_tag: ${{ steps.staging_prepare.outputs.new_tag }}
    concurrency:
      group: staging_incr_version
      cancel-in-progress: false
    if: contains(vars.ALLOWED_USERS, github.actor)
    steps:
      - name: Checkout ðŸ‘€
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          lfs: false
      - name: Staging prepare ðŸš—
        id: staging_prepare
        run: |
          echo "Staging prepare."
          echo ${{ secrets.AWS_ACCESS_KEY_ID }}
          LATEST_TAG=$( git describe --tags --abbrev=0 )
          NEW_TAG=$(echo $LATEST_TAG | awk -F '.' '{ print $1 "." $2 "." $3+1 }')
          git tag $NEW_TAG
          git push origin $NEW_TAG
          echo "new_tag=$NEW_TAG" >> "$GITHUB_OUTPUT"
  staging_frontend_build:
    name: Build FrontEnd
    environment: staging
    runs-on: self-hosted
    needs: [staging_prepare]
    steps:
      - name: Staging FrontEnd Build ðŸš—
        env:
          NEW_TAG: ${{needs.staging_prepare.outputs.new_tag}}
        run: |
          echo "Staging FrontEnd build."
          echo "$NEW_TAG"
  staging_containers_build:
    name: Build Containers
    environment: staging
    runs-on: self-hosted
    needs: [staging_prepare]
    steps:
      - name: Staging Container Build ðŸš—
        env:
          NEW_TAG: ${{needs.staging_prepare.outputs.new_tag}}
        run: |
          echo "Staging container build."
          echo "$NEW_TAG"
  staging_deploy:
    name: Deploy with ${{needs.staging_prepare.outputs.new_tag}} tag
    environment: 
      name: staging
      url: https://google.com
    runs-on: self-hosted
    concurrency:
      group: staging
      cancel-in-progress: false
    needs: [staging_prepare, staging_frontend_build, staging_containers_build]
    steps:
      - name: Staging Deploy ðŸš—
        env:
          NEW_TAG: ${{needs.staging_prepare.outputs.new_tag}}
        run: |
          echo "Staging Deploy."
          echo "$NEW_TAG"
  staging_tests:
    uses: ./.github/workflows/ci.yml
    needs: [staging_deploy]
  e2e_cypress_staging:
    runs-on: self-hosted
    concurrency:
      group: staging
      cancel-in-progress: false
    needs: [staging_deploy]
    steps:
      - name: E2E Staging Cypress tests ðŸš—
        run: |
          echo "Staging e2e_cypress tests...."
